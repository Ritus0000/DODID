<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Dodid</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">
<meta name="apple-mobile-web-app-title" content="Dodid">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700&display=swap" rel="stylesheet">

<style>
  :root{
    --accent:#ffd000;
    --ink:#000;
    --muted:#777;
    --ring:#aaa;
    --brand:#8a8a8a;
    --phone-w:390px; --phone-h:844px;

    --pop-duration:520ms; /* –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–æ–∂–¥–µ–Ω–∏–µ –∫—Ä—É–∂–∫–∞ */
  }

  /* === –ñ—ë—Å—Ç–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ === */
  html, body{
    height:100%;
    margin:0;
    overflow:hidden;                /* —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è */
    overscroll-behavior:none;       /* –±–µ–∑ —Ä–µ–∑–∏–Ω–∫–∏ */
    background:#fff;
    -webkit-text-size-adjust:100%;
  }

  /* –°—Ç–∞–±–∏–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—ã—Å–æ—Ç—ã: svh -> dvh, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ */
  :root{ --vh: 100svh; }
  @supports (height: 100dvh) { :root{ --vh: 100dvh; } }

  body{ font-family:"Helvetica Neue",-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; color:var(--ink); }
  .wrapper{ min-height:100%; display:flex; align-items:center; justify-content:center; background:#e9edf1; padding:16px; box-sizing:border-box; }
  .phone{
    width:var(--phone-w); height:var(--phone-h); background:#fff; border-radius:34px; box-shadow:0 18px 50px rgba(0,0,0,18); position:relative; overflow:hidden;
  }

  /* –ú–æ–±–∏–ª—å–Ω—ã–π –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–æ –≤—å—é–ø–æ—Ä—Ç—É */
  @media (max-width:480px),(hover:none) and (pointer:coarse){
    .wrapper{padding:0; background:#fff;}
    .phone{
      width:100%;
      height:var(--vh);
      border-radius:0; box-shadow:none;
      position:fixed; inset:0;     /* –ö–õ–Æ–ß ‚Äî –Ω–µ ¬´–µ–∑–¥–∏—Ç¬ª –∑–∞ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π */
    }
  }

  .statusbar{ height:47px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; font-size:14px; font-weight:600; background:#fff; }
  .island{ position:absolute; top:9px; left:50%; transform:translateX(-50%); width:120px; height:32px; background:#000; border-radius:20px; }

  .app{ position:absolute; inset:0; padding:70px 16px calc(24px + env(safe-area-inset-bottom)) 16px; box-sizing:border-box; display:flex; flex-direction:column; background:#fff; -webkit-tap-highlight-color:transparent; }

  .header{ font-size:32px; font-weight:800; margin-bottom:10px; }

  /* –°–ø–∏—Å–æ–∫ ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ —Ä–∞–∑—Ä–µ—à—ë–Ω —Å–∫—Ä–æ–ª–ª */
  #tasks{
    list-style:none; margin:0; padding:0; flex:1; overflow:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width: none;
  }
  #tasks.scrolling{ scrollbar-width: thin; scrollbar-color: rgba(0,0,0,22) transparent; }
  #tasks::-webkit-scrollbar{ width:1px; height:1px; }
  #tasks::-webkit-scrollbar-button{ display:none; width:0; height:0; }
  #tasks::-webkit-scrollbar-track{ background:transparent; }
  #tasks::-webkit-scrollbar-thumb{ background-color:rgba(0,0,0,0); border-radius:0; }
  #tasks.scrolling::-webkit-scrollbar-thumb{ background-color:rgba(0,0,0,24); }

  .scroll-spacer{ height:45vh; }

  /* –°—Ç—Ä–æ–∫–∞ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
  li{ display:flex; align-items:flex-start; padding:6px 4px; font-size:18px; line-height:1.25; }

  /* –ö—Ä—É–∂–æ–∫ */
  .circle{
    width:20px; height:20px; border:2px solid var(--ring);
    border-radius:50%; margin-right:10px; margin-top:2px; flex-shrink:0;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition: transform 90ms ease, box-shadow 90ms ease, background-color 140ms ease, border-color 140ms ease;
    box-shadow:none; position:relative;
  }
  .circle.touch{ transform:scale(0.95); box-shadow: inset 0 1.5px 3px rgba(0,0,0,25); }
  .circle.born{ animation: pop var(--pop-duration) cubic-bezier(.2,8,2,1) forwards; transform:scale(0); }
  @keyframes pop{ 0%{transform:scale(0);} 70%{transform:scale(1.14);} 100%{transform:scale(1);} }

  /* –ì–∞–ª–æ—á–∫–∞ ‚Äî —Å—Ç–∞—Ç–∏—á–Ω–æ */
  .tick{ width:14px; height:14px; display:block; }
  .tick path{ fill:none; stroke:#fff; stroke-width:2.2; stroke-linecap:round; }
  .done .circle{ background:var(--accent); border-color:var(--accent); }

  /* –¢–µ–∫—Å—Ç + placeholder */
  .textwrap{ position:relative; flex:1; }
  .task-text{
    position:relative;
    min-height:1.25em; white-space:pre-wrap; word-break:break-word;
    outline:none; border:none; background:transparent; font:inherit; color:var(--ink);
    padding:2px 0 4px;
  }
  .task-text::before{
    content: attr(data-placeholder);
    position:absolute; left:0; top:0;
    color:#b4b4b4; pointer-events:none;
    opacity:0; transform: translateY(2px);
    transition: opacity 220ms ease, transform 220ms ease;
  }
  .task-text.empty::before{ opacity:1; transform: translateY(0); }
  .done .task-text{ color:var(--muted); }

  /* –ü–µ—Ä–µ—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ (SVG) */
  .strike-svg{ position:absolute; inset:0; pointer-events:none; overflow:visible; }
  .strike-line{
    stroke: currentColor; stroke-width:1; stroke-linecap:round;
    stroke-dasharray: var(--len, 0); stroke-dashoffset: var(--len, 0);
    transition: stroke-dashoffset 220ms ease-out; opacity:.95;
  }

  /* –ù–∏–∂–Ω–∏–π –¥–æ–∫ */
  .bottomDock{
    position:absolute; left:16px; right:16px; bottom:calc(20px + env(safe-area-inset-bottom));
    background:#fff; border-radius:0; padding:10px 12px;
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:none; z-index:12;
  }
  .brand{ font-family:"Fredoka",system-ui,-apple-system,sans-serif; font-weight:700; font-size:22px; letter-spacing:.5px; color:var(--brand); user-select:none; }

  /* FAB */
  .fab{
    width:54px; height:54px; border-radius:50%;
    background:var(--accent); color:#fff; font-size:32px; line-height:0;
    border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
    box-shadow:0 6px 12px rgba(0,0,0,16);
    will-change:transform, box-shadow; transition: transform 120ms ease, box-shadow 120ms ease;
  }
  .fab.pressed{ box-shadow:none; transform:translateY(2px) scale(0.98); }

  @media (prefers-reduced-motion:reduce){ *{ animation:none !important; transition:none !important; } }
</style>
</head>
<body>
  <div class="wrapper">
    <div class="phone">
      <div class="statusbar">
        <div id="time">9:41</div>
        <div style="width:40px; text-align:right;">üì∂ üîã</div>
        <div class="island"></div>
      </div>

      <div class="app">
        <div class="header" id="dayHeader">–°—Ä–µ–¥–∞</div>

        <ul id="tasks"></ul>

        <div class="bottomDock">
          <div class="brand">DODID</div>
          <button class="fab" id="addBtn" aria-label="+">+</button>
        </div>
      </div>
    </div>
  </div>

<script>
  /* –í—Ä–µ–º—è */
  function updateTime(){
    const now = new Date();
    let h = now.getHours(), m = now.getMinutes();
    if(m < 10) m = "0"+m;
    document.getElementById("time").textContent = h + ":" + m;
  }
  setInterval(updateTime, 1000); updateTime();

  /* –•—Ä–∞–Ω–∏–ª–∏—â–µ */
  const KEY='dodid_tasks_v1', START_TASKS=3;
  let tasks=[];
  const raw=localStorage.getItem(KEY);
  if(raw===null){ tasks=Array.from({length:START_TASKS},()=>({text:'',done:false})); localStorage.setItem(KEY, JSON.stringify(tasks)); }
  else{ try{ tasks=JSON.parse(raw)||[] }catch{ tasks=[] } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(tasks)); }

  const list=document.getElementById('tasks');
  const addBtn=document.getElementById('addBtn');
  let scrollHideTimer=null;

  /* –ü–æ–∫–∞–∑ —Ç–æ–Ω–∫–æ–π –ø–æ–ª–æ—Å—ã —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è —Å–∫—Ä–æ–ª–ª–∞ */
  function tempShowScrollbar(){
    list.classList.add('scrolling');
    clearTimeout(scrollHideTimer);
    scrollHideTimer=setTimeout(()=> list.classList.remove('scrolling'), 800);
  }
  list.addEventListener('scroll', tempShowScrollbar, {passive:true});

  /* –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç–∞—á-—Å–∫—Ä–æ–ª–ª –≤–Ω–µ —Å–ø–∏—Å–∫–∞ */
  document.addEventListener('touchmove', (e)=>{
    if(!e.target.closest('#tasks')) e.preventDefault();
  }, {passive:false});

  /* –ì–∞–ª–æ—á–∫–∞ (—Å—Ç–∞—Ç–∏—á–Ω–æ) */
  function makeTickSVGStatic(){
    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg');
    svg.setAttribute('viewBox','0 0 14 14'); svg.classList.add('tick');
    const p1=document.createElementNS(svgNS,'path'); p1.setAttribute('d','M3 7 L6 10');
    const p2=document.createElementNS(svgNS,'path'); p2.setAttribute('d','M6 10 L11 3');
    svg.appendChild(p1); svg.appendChild(p2); return svg;
  }

  /* –ú–µ—Ç—Ä–∏–∫–∏ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –∑–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è */
  let fontMetricsCache = null;
  function computeFontMetricsFor(el){
    const cs = getComputedStyle(el);
    let font = cs.font;
    if(!font || font === 'normal'){
      const style = cs.fontStyle || 'normal';
      const weight = cs.fontWeight || '400';
      const size = cs.fontSize || '18px';
      const line = cs.lineHeight && cs.lineHeight !== 'normal' ? cs.lineHeight : size;
      const family = cs.fontFamily || 'Helvetica Neue, Arial, sans-serif';
      font = `${style} ${weight} ${size}/${line} ${family}`;
    }
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = font;
    const sample = '–∫–µ–Ω–≥—à–∑—Ö—ã–≤–∞–ø–æ–ª–∂—ç—è—á—Å–º–∏—Ç—å—é';
    const m = ctx.measureText(sample);
    const ascent  = m.actualBoundingBoxAscent || 0;
    const descent = m.actualBoundingBoxDescent || 0;
    if(ascent === 0 && descent === 0) return null;
    return { ascent, descent };
  }
  function getFontMetrics(el){
    if(fontMetricsCache) return fontMetricsCache;
    fontMetricsCache = computeFontMetricsFor(el);
    return fontMetricsCache;
  }

  function syncEmptyClass(el){
    if((el.textContent||'').trim()==='') el.classList.add('empty'); else el.classList.remove('empty');
  }

  /* –ü–µ—Ä–µ—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
  function buildStrike(textWrap, animate=true){
    const old = textWrap.querySelector('.strike-svg'); if(old) old.remove();
    const textEl = textWrap.querySelector('.task-text'); if(!textEl) return;

    syncEmptyClass(textEl);

    const range = document.createRange(); range.selectNodeContents(textEl);
    const rects = Array.from(range.getClientRects());

    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg'); svg.classList.add('strike-svg');

    const parentRect=textWrap.getBoundingClientRect();
    svg.setAttribute('width', parentRect.width);
    svg.setAttribute('height', parentRect.height);
    svg.setAttribute('viewBox', `0 0 ${parentRect.width} ${parentRect.height}`);

    const metrics = getFontMetrics(textEl);
    const fallbackRatio = 0.56;

    rects.forEach(r=>{
      const x1 = r.left - parentRect.left;
      const x2 = r.right - parentRect.left;
      const len = Math.max(0, x2 - x1);
      if(len <= 0) return;

      let yLocal;
      if(metrics){
        const baseline = (r.bottom - parentRect.top) - metrics.descent;
        const xHeight  = metrics.ascent; // –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
        yLocal = baseline - (xHeight / 2);
      }else{
        yLocal = (r.top - parentRect.top) + r.height * fallbackRatio;
      }

      const line=document.createElementNS(svgNS,'line');
      line.setAttribute('x1', x1); line.setAttribute('y1', yLocal);
      line.setAttribute('x2', x2); line.setAttribute('y2', yLocal);
      line.classList.add('strike-line');
      line.style.setProperty('--len', `${len}`);

      if(!animate){ line.style.strokeDashoffset=0; line.style.transition='none'; }
      svg.appendChild(line);

      if(animate){ requestAnimationFrame(()=>{ line.style.strokeDashoffset=0; }); }
    });

    textWrap.appendChild(svg);
  }

  /* –†–µ–Ω–¥–µ—Ä */
  function render(){
    list.innerHTML='';

    for(let i=0;i<tasks.length;i++){
      const t=tasks[i];
      const li=document.createElement('li'); if(t.done) li.classList.add('done');

      const circle=document.createElement('div'); circle.className='circle';
      if(t.done){ circle.appendChild(makeTickSVGStatic()); }

      circle.addEventListener('pointerdown', ()=> circle.classList.add('touch'));
      circle.addEventListener('pointerup',   ()=> circle.classList.remove('touch'));
      circle.addEventListener('pointercancel',()=> circle.classList.remove('touch'));
      circle.addEventListener('pointerleave', ()=> circle.classList.remove('touch'));

      const textWrap=document.createElement('div'); textWrap.className='textwrap';
      const text=document.createElement('div');
      text.className='task-text'; text.contentEditable='true'; text.spellcheck=false;
      text.dataset.placeholder='–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞‚Ä¶'; text.textContent=t.text||'';
      syncEmptyClass(text);

      textWrap.appendChild(text);
      li.appendChild(circle);
      li.appendChild(textWrap);
      list.appendChild(li);

      circle.addEventListener('click', ()=>{
        if((text.textContent||'').trim()==='') return;
        t.done=!t.done; save();
        if(t.done){
          li.classList.add('done');
          const old=circle.querySelector('svg.tick'); if(old) old.remove();
          circle.appendChild(makeTickSVGStatic());
          buildStrike(textWrap, true);
        }else{
          li.classList.remove('done');
          const old=circle.querySelector('svg.tick'); if(old) old.remove();
          const s=textWrap.querySelector('.strike-svg'); if(s) s.remove();
        }
      });

      text.addEventListener('input', ()=>{
        tasks[i].text=text.textContent; save(); syncEmptyClass(text);
        if(t.done) buildStrike(textWrap, false);
      });

      /* –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ */
      text.addEventListener('keydown',(e)=>{
        const val=(text.textContent||'').trim();
        if((e.key==='Backspace'||e.key==='Delete') && val===''){
          e.preventDefault();
          const goPrev=(e.key==='Backspace');
          const nextIndex=goPrev?Math.max(0, i-1):Math.min(tasks.length-1, i+1);
          tasks.splice(i,1); save(); render();
          const targetLi=list.children[Math.min(nextIndex, list.children.length-2)];
          if(targetLi){
            const ti=targetLi.querySelector('.task-text');
            if(ti){
              try{ ti.focus({preventScroll:true}); }catch{ ti.focus(); }
            }
          }
        }
      });

      if(t.done) buildStrike(textWrap, false);
    }

    const spacer=document.createElement('li'); spacer.className='scroll-spacer'; spacer.setAttribute('aria-hidden','true'); list.appendChild(spacer);
  }

  /* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ ‚Äî —Ñ–æ–∫—É—Å –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
  function addTask(){
    tasks.push({text:'',done:false}); save(); render();

    const lastLi=list.querySelector('li:nth-last-child(2)'); // –ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–∞–ª—å–Ω–∞—è
    if(lastLi){
      const c = lastLi.querySelector('.circle');
      const tx = lastLi.querySelector('.task-text');

      if(c){ c.classList.add('born'); setTimeout(()=>c.classList.remove('born'), 800); }
      if(tx){
        try{ tx.focus({preventScroll:true}); }catch{ tx.focus(); }
        tx.classList.add('empty');
        tx.classList.add('ph-anim-start');
        requestAnimationFrame(()=>{
          tx.classList.add('ph-appear');
          setTimeout(()=> tx.classList.remove('ph-anim-start','ph-appear'), 260);
        });
      }
    }
  }

  addBtn.addEventListener('pointerdown', ()=> addBtn.classList.add('pressed'));
  addBtn.addEventListener('pointerup',   ()=> addBtn.classList.remove('pressed'));
  addBtn.addEventListener('pointercancel',()=> addBtn.classList.remove('pressed'));
  addBtn.addEventListener('pointerleave', ()=> addBtn.classList.remove('pressed'));
  addBtn.addEventListener('click', addTask);

  render();

  /* –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é ‚Äî –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ */
  (function(){
    const first=Array.from(document.querySelectorAll('.task-text')).find(n=>(n.textContent||'').trim()==='');
    if(first){
      try{ first.focus({preventScroll:true}); }catch{ first.focus(); }
    }
  })();

  /* –ü–µ—Ä–µ—Å—á—ë—Ç –∑–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ */
  window.addEventListener('resize', ()=>{
    document.querySelectorAll('li').forEach(li=>{
      if(li.classList.contains('done')){
        const wrap=li.querySelector('.textwrap'); if(wrap) buildStrike(wrap,false);
      }
    });
  });
</script>
</body>
</html>
